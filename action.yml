name: 'Melos Build Runner'
description: 'Run the Melos Build Runner for Dart/Flutter projects'
author: 'Klarity.app <info@klarity.app>'
branding:
  icon: 'package'
  color: 'purple'

inputs:
  output_paths:
    description: 'Multiline list of output file paths generated by the build-runner. Each line represents a glob pattern for matching generated files.'
    required: false
    default: |
      **/*.g.dart
      **/*.gr.dart
      **/*.gen.dart
      **/*generated.dart
      **/*.mocks.dart
      **/*.freezed.dart
      **/*.io.dart
  melos_command:
    description: 'The full Melos command to execute the build runner'
    required: false
    default: 'melos exec -c 1 --depends-on="build_runner" -- dart pub run build_runner build --delete-conflicting-outputs'

runs:
  using: "composite"
  steps:
    - name: Cache Build Runner Output
      uses: actions/cache@v3
      id: melos_build_runner_cache
      with:
        path: ${{ inputs.output_paths }}
        key: melos_build_runner_cache_${{ runner.os }}_${{ github.sha }}

    - name: Setup Melos
      uses: bluefireteam/melos-action@v3
      
    - name: Run Build Runner
      if: steps.melos_build_runner_cache.outputs.cache-hit != 'true'
      run: ${{ inputs.melos_command }}
      shell: bash
